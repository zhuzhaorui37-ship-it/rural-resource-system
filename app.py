# =====================================================
# ä¹¡æ‘èµ„æºç»¼åˆåˆ†æç³»ç»Ÿ - Streamlit ä¸»ç¨‹åºï¼ˆç»ˆææäº¤ç‰ˆï¼‰
# =====================================================

import streamlit as st
import pandas as pd
import plotly.express as px
import matplotlib.pyplot as plt
import jieba
from wordcloud import WordCloud
from pathlib import Path
import warnings

from streamlit_folium import st_folium
# æ³¨ï¼šè‹¥ product_resource.py å’Œ land_type.py ä¸åœ¨ç¯å¢ƒä¸­ï¼Œéœ€ç¡®ä¿æ–‡ä»¶å­˜åœ¨æˆ–æ³¨é‡Šç›¸å…³å¯¼å…¥
# è‹¥è¿è¡ŒæŠ¥é”™ï¼Œå¯å…ˆæ³¨é‡Šä»¥ä¸‹ä¸¤è¡Œï¼Œå¾…æ–‡ä»¶å‡†å¤‡åæ¢å¤
from product_resource import get_resource_map_for_streamlit
from land_type import ç”Ÿæˆæ‘åº„åœŸåœ°åˆ†æç»“æœ

warnings.filterwarnings("ignore")

# =====================================================
# è·¯å¾„ç®¡ç†ï¼ˆä¿ç•™ä½†è¯äº‘éƒ¨åˆ†æ”¹ç”¨ç³»ç»Ÿå†…ç½®å­—ä½“ï¼‰
# =====================================================
BASE_DIR = Path(__file__).resolve().parent
FONT_DIR = BASE_DIR / "fonts"

# =====================================================
# é¡µé¢é…ç½®
# =====================================================
st.set_page_config(
    page_title="ä¹¡æ‘èµ„æºç»¼åˆåˆ†æç³»ç»Ÿ",
    page_icon="ğŸŒ¾",
    layout="wide"
)

# =====================================================
# é¡µé¢æ ‡é¢˜
# =====================================================
st.title("ğŸŒ¾ ä¹¡æ‘èµ„æºç»¼åˆåˆ†æç³»ç»Ÿ")
st.caption("åŸºäºå¤šæºæ•°æ®ä¸å¯è§£é‡Š AI çš„ä¹¡æ‘ç‰¹è‰²äº§ä¸šæ™ºèƒ½å†³ç­–æ”¯æŒç³»ç»Ÿ")
st.divider()

menu = st.sidebar.selectbox(
    "åŠŸèƒ½æ¨¡å—",
    [
        "å†œäº§å“è¯„è®ºåˆ†æ",
        "ä¹¡æ‘å¤šæºèµ„æºåˆ†å¸ƒ",
        "åœŸåœ°èµ„æºæ™ºèƒ½è¯„ä¼°",
        "ç‰¹è‰²äº§ä¸šè§„åˆ’"
    ]
)

# =====================================================
# æ¨¡å—ä¸€ï¼šå†œäº§å“è¯„è®ºåˆ†æï¼ˆæ ¸å¿ƒä¿®æ”¹è¯äº‘éƒ¨åˆ†ï¼‰
# =====================================================
if menu == "å†œäº§å“è¯„è®ºåˆ†æ":
    st.header("ğŸ¥¬ å†œäº§å“è¯„è®ºåˆ†æ")

    product = st.text_input("è¯·è¾“å…¥å†œäº§å“åç§°ï¼ˆå¦‚ï¼šç« ä¸˜å¤§è‘±ï¼‰")

    if st.button("å¼€å§‹åˆ†æ") and product:
        comments = {
    "ç« ä¸˜å¤§è‘±": [
        ("å¥½è¯„", "å¤§è‘±éå¸¸æ–°é²œï¼Œè„†ç”œå¯å£"),
        ("å¥½è¯„", "ç« ä¸˜äº§åœ°ç›´å‘ï¼Œå“è´¨æœ‰ä¿éšœ"),
        ("å¥½è¯„", "è‘±ç™½é•¿ï¼Œé¦™å‘³æµ“ï¼Œé€‚åˆçˆ†ç‚’"),
        ("å¥½è¯„", "æ¯”è¶…å¸‚ä¹°çš„æ–°é²œå¾ˆå¤š"),
        ("å¥½è¯„", "åŒ…è£…ç»“å®ï¼Œæ²¡æœ‰å‹å"),
        ("å¥½è¯„", "ç‚’è‚‰ã€ç‚–èœéƒ½å¾ˆé¦™"),
        ("å¥½è¯„", "å£æ„Ÿæ¸…ç”œï¼Œæ²¡æœ‰è¾›è¾£å‘³"),
        ("å¥½è¯„", "å®¶é‡Œè€äººå­©å­éƒ½çˆ±åƒ"),
        ("å¥½è¯„", "å›è´­å¾ˆå¤šæ¬¡äº†"),
        ("å¥½è¯„", "åœ°é“çš„ç« ä¸˜å¤§è‘±"),
        ("ä¸­è¯„", "æ•´ä½“ä¸é”™ï¼Œå°±æ˜¯ç‰©æµç¨æ…¢"),
        ("ä¸­è¯„", "ä¸ªå¤´å¤§å°ä¸å¤ªå‡åŒ€"),
        ("ä¸­è¯„", "éƒ¨åˆ†è‘±å¶æœ‰ç‚¹è€"),
        ("ä¸­è¯„", "ä»·æ ¼ç•¥é«˜ï¼Œä½†èƒ½æ¥å—"),
        ("å·®è¯„", "æœ‰ä¸€æ ¹è¿è¾“é€”ä¸­æ–­äº†"),
        ("å·®è¯„", "å¤–åŒ…è£…æœ‰ç‚¹æ¹¿"),
        ("å·®è¯„", "æ”¶åˆ°æ—¶æœ‰è½»å¾®é»„å¶")
    ],

    "çƒŸå°è‹¹æœ": [
        # -------- å¥½è¯„ï¼ˆ30æ¡å·¦å³ï¼‰--------
        ("å¥½è¯„", "è‹¹æœéå¸¸è„†ç”œï¼Œå¤šæ±"),
        ("å¥½è¯„", "çƒŸå°è‹¹æœæœç„¶åä¸è™šä¼ "),
        ("å¥½è¯„", "å£æ„Ÿæ¸…çˆ½ï¼Œç”œåº¦é€‚ä¸­"),
        ("å¥½è¯„", "å­©å­å¾ˆå–œæ¬¢åƒ"),
        ("å¥½è¯„", "æœé¦™å‘³å¾ˆæµ“"),
        ("å¥½è¯„", "æ–°é²œç°æ‘˜ï¼Œæ°´åˆ†å……è¶³"),
        ("å¥½è¯„", "æ¯”è¶…å¸‚ä¹°çš„å¥½åƒ"),
        ("å¥½è¯„", "è‹¹æœä¸ªå¤´å‡åŒ€"),
        ("å¥½è¯„", "å¤–çš®å…‰æ»‘ï¼Œæ²¡æœ‰ç¢°ä¼¤"),
        ("å¥½è¯„", "åŒ…è£…ä¸¥å®ï¼Œæ²¡æœ‰åæœ"),
        ("å¥½è¯„", "åˆ‡å¼€åæœè‚‰å¾ˆç™½"),
        ("å¥½è¯„", "ç”œä¸­å¸¦é…¸ï¼Œå¾ˆå¼€èƒƒ"),
        ("å¥½è¯„", "é€‚åˆç›´æ¥åƒä¹Ÿé€‚åˆæ¦¨æ±"),
        ("å¥½è¯„", "å®¶é‡Œè€äººä¹Ÿè¯´å¥½åƒ"),
        ("å¥½è¯„", "å›è´­ç¬¬äºŒæ¬¡äº†"),
        ("å¥½è¯„", "ç§‹å¤©çš„è‹¹æœç‰¹åˆ«å¥½åƒ"),
        ("å¥½è¯„", "æœè‚‰ç´§å®ï¼Œä¸æ˜¯é¢è‹¹æœ"),
        ("å¥½è¯„", "åšè‹¹æœæ²™æ‹‰å¾ˆå¥½"),
        ("å¥½è¯„", "æ€§ä»·æ¯”å¾ˆé«˜"),
        ("å¥½è¯„", "ç‰©æµå¾ˆå¿«ï¼Œæ”¶åˆ°å¾ˆæ–°é²œ"),
        ("å¥½è¯„", "æ²¡æœ‰æ‰“èœ¡çš„æ„Ÿè§‰"),
        ("å¥½è¯„", "è‹¹æœé¦™å‘³è‡ªç„¶"),
        ("å¥½è¯„", "æ°´åˆ†å¤šï¼Œåƒç€ä¸è…»"),
        ("å¥½è¯„", "æ¯å¤©ä¸€ä¸ªè‹¹æœå¾ˆåˆé€‚"),
        ("å¥½è¯„", "ç»™å­©å­å½“é›¶é£Ÿå¾ˆæ”¾å¿ƒ"),
        ("å¥½è¯„", "æœ‹å‹æ¨èä¹°çš„ï¼Œç¡®å®ä¸é”™"),
        ("å¥½è¯„", "åˆ‡å¼€æ²¡æœ‰å‘é»‘"),
        ("å¥½è¯„", "æœæ ¸å°ï¼Œæœè‚‰å¤š"),
        ("å¥½è¯„", "ç”œåº¦æ¯”é¢„æœŸé«˜"),
        ("å¥½è¯„", "åšè‹¹æœæ´¾ä¹Ÿå¾ˆå¥½åƒ"),

        # -------- ä¸­è¯„ï¼ˆ12æ¡å·¦å³ï¼‰--------
        ("ä¸­è¯„", "æ•´ä½“ä¸é”™ï¼Œä¸ªåˆ«ç•¥å°"),
        ("ä¸­è¯„", "æœ‰å‡ ä¸ªè‹¹æœé¢œè‰²ä¸å¤ªå‡åŒ€"),
        ("ä¸­è¯„", "ç”œåº¦æœ‰å·®å¼‚"),
        ("ä¸­è¯„", "éƒ¨åˆ†è‹¹æœç•¥é…¸"),
        ("ä¸­è¯„", "å¤§å°å‚å·®ï¼Œä½†èƒ½æ¥å—"),
        ("ä¸­è¯„", "ä»·æ ¼ç¨é«˜"),
        ("ä¸­è¯„", "åŒ…è£…å¯ä»¥å†åŠ å¼º"),
        ("ä¸­è¯„", "æœçš®ç¨åš"),
        ("ä¸­è¯„", "ä¸å¦‚å»å¹´ä¹°çš„ç”œ"),
        ("ä¸­è¯„", "éƒ¨åˆ†è‹¹æœæˆç†Ÿåº¦ä¸€èˆ¬"),
        ("ä¸­è¯„", "æœ‰è½»å¾®ç£•ç¢°"),
        ("ä¸­è¯„", "æ•´ä½“è¿˜å¯ä»¥"),

        # -------- å·®è¯„ï¼ˆ8æ¡å·¦å³ï¼‰--------
        ("å·®è¯„", "æœ‰ä¸€ä¸ªè‹¹æœåäº†"),
        ("å·®è¯„", "ä¸ªåˆ«è‹¹æœæœ‰ç£•ç¢°"),
        ("å·®è¯„", "æ”¶åˆ°æ—¶æœ‰è½¯æœ"),
        ("å·®è¯„", "åŒ…è£…æœ‰ç‚¹ç®€é™‹"),
        ("å·®è¯„", "æœ‰ä¸ªè‹¹æœå£æ„Ÿåé¢"),
        ("å·®è¯„", "ä¸ªå¤´æ¯”æƒ³è±¡çš„å°"),
        ("å·®è¯„", "æœ‰è½»å¾®å‹ç—•"),
        ("å·®è¯„", "ä¸æè¿°ç•¥æœ‰å·®è·")
    ]
}.get(product, [("æš‚æ— ", "æš‚æ— è¯„è®ºæ•°æ®")])

        total = len(comments)
        good = sum(1 for c in comments if c[0] == "å¥½è¯„")

        col1, col2 = st.columns(2)
        col1.metric("å¥½è¯„ç‡", f"{(good / total * 100):.1f}%" if total else "0%")
        col2.metric("è¯„è®ºæ€»æ•°", total)

        st.subheader("è¯„è®ºè¯¦æƒ…")
        for t, c in comments:
            st.write(f"ã€{t}ã€‘{c}")

        st.subheader("å…³é”®è¯è¯äº‘åˆ†æ")
        # æå–è¯„è®ºæ–‡æœ¬å¹¶åˆ†è¯
        text = " ".join([c[1] for c in comments])
        words = " ".join(w for w in jieba.lcut(text) if len(w) > 1)
        
        # æ•°æ®å…œåº•ï¼šé¿å…æ— æœ‰æ•ˆå…³é”®è¯å¯¼è‡´è¯äº‘ç”Ÿæˆå¤±è´¥
        if not words.strip():
            words = f"{product} å¥½è¯„ ä¸­è¯„ å·®è¯„ å“è´¨ å£æ„Ÿ"

        # ========== æ ¸å¿ƒä¿®æ”¹ï¼šé€‚é…Streamlit Cloudçš„å­—ä½“ ==========
        wc = WordCloud(
            font_path="/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",  # Linuxå†…ç½®å­—ä½“ï¼ˆäº‘ç«¯å…¼å®¹ï¼‰
            background_color="white",
            width=800,
            height=400,
            max_words=100,
            collocations=False  # é¿å…é‡å¤å…³é”®è¯
        ).generate(words)

        # ä¼˜åŒ–è¯äº‘æ˜¾ç¤ºæ•ˆæœ
        fig, ax = plt.subplots(figsize=(10, 6))
        ax.imshow(wc, interpolation="bilinear")
        ax.axis("off")
        plt.tight_layout()  # å»é™¤å¤šä½™è¾¹è·
        st.pyplot(fig)

# =====================================================
# æ¨¡å—äºŒï¼šä¹¡æ‘å¤šæºèµ„æºåˆ†å¸ƒï¼ˆproduct_resource.pyï¼‰
# =====================================================
elif menu == "ä¹¡æ‘å¤šæºèµ„æºåˆ†å¸ƒ":
    st.header("ğŸï¸ ä¹¡æ‘å¤šæºèµ„æºç©ºé—´åˆ†å¸ƒåˆ†æ")

    village = st.text_input("è¯·è¾“å…¥æ‘åº„åç§°")

    if st.button("ç”Ÿæˆèµ„æºåˆ†å¸ƒåœ°å›¾") and village:
        st.subheader("å¤šæºä¹¡æ‘èµ„æºç»¼åˆåˆ†å¸ƒå›¾")

        html, summary = get_resource_map_for_streamlit(village)

        # ä½¿ç”¨ HTML æ–¹å¼æ¸²æŸ“ Foliumï¼ˆæœ€ç¨³ï¼‰
        st.components.v1.html(
            html,
            height=650,
            scrolling=True
        )

        with st.expander("ğŸ“„ æ‘åº„ç»¼åˆèµ„æºæ–‡å­—æ¦‚å†µ"):
            st.markdown(f"""
**ğŸ“ åœ°ç†åæ ‡**ï¼š{summary['åœ°ç†åæ ‡']}

**ğŸŒ¿ èµ„æºæ¦‚å†µ**  
{summary['èµ„æºæ¦‚å†µ']}

**ğŸ äº§å“æ¦‚å†µ**  
{summary['äº§å“æ¦‚å†µ']}

**ğŸ¡ äººæ–‡æ¦‚å†µ**  
{summary['äººæ–‡æ¦‚å†µ']}
""")

# =====================================================
# æ¨¡å—ä¸‰ï¼šåœŸåœ°èµ„æºæ™ºèƒ½è¯„ä¼°ï¼ˆland_type.pyï¼‰
# =====================================================
elif menu == "åœŸåœ°èµ„æºæ™ºèƒ½è¯„ä¼°":
    st.header("ğŸŒ± åœŸåœ°èµ„æºæ™ºèƒ½è¯„ä¼°")

    village = st.text_input("è¯·è¾“å…¥æ‘åº„åç§°")

    if st.button("å¼€å§‹åœŸåœ°åˆ†æ") and village:
        df_land, map_file = ç”Ÿæˆæ‘åº„åœŸåœ°åˆ†æç»“æœ(village)

        st.subheader("åœŸåœ°èµ„æºæ™ºèƒ½åˆ†ç±»ç»“æœï¼ˆK-Means èšç±»ï¼‰")
        st.dataframe(
            df_land[
                ["land_id", "soil_fertility", "slope",
                 "road_distance", "area", "åœŸåœ°ç±»å‹"]
            ],
            use_container_width=True
        )

        st.info("ä¸‹å›¾å±•ç¤ºåœŸåœ°èµ„æºçš„ç©ºé—´åˆ†å¸ƒåŠå…¶æ™ºèƒ½åˆ†ç±»ç»“æœ")

        # æ¸²æŸ“ç”Ÿæˆçš„HTMLåœ°å›¾
        with open(map_file, "r", encoding="utf-8") as f:
            html = f.read()

        st.components.v1.html(html, height=650, scrolling=True)

# =====================================================
# æ¨¡å—å››ï¼šç‰¹è‰²äº§ä¸šè§„åˆ’
# =====================================================
elif menu == "ç‰¹è‰²äº§ä¸šè§„åˆ’":
    st.header("ğŸ­ ç‰¹è‰²äº§ä¸šè§„åˆ’")

    village = st.text_input("è¯·è¾“å…¥æ‘åº„åç§°")

    if st.button("ç”Ÿæˆäº§ä¸šè§„åˆ’æ–¹æ¡ˆ") and village:
        st.subheader(f"{village} ç‰¹è‰²äº§ä¸šå‘å±•è§„åˆ’ï¼ˆæ™ºèƒ½æ¨èï¼‰")

        st.markdown("""
### ğŸŒŸ ä¸€ã€ä¸»å¯¼äº§ä¸šå®šä½
- é«˜æ•ˆè®¾æ–½å†œä¸šï¼ˆè”¬èœã€ç‰¹è‰²æœå“ï¼‰
- å†œäº§å“ç²¾æ·±åŠ å·¥äº§ä¸š
- ä¹¡æ‘ä¼‘é—²ä¸ç ”å­¦äº§ä¸š

### ğŸŒ± äºŒã€äº§ä¸šå¸ƒå±€è§„åˆ’
- **æ ¸å¿ƒç”Ÿäº§åŒº**ï¼šé›†ä¸­è¿ç‰‡è®¾æ–½å†œä¸šç¤ºèŒƒåŒº  
- **åŠ å·¥å¢å€¼åŒº**ï¼šå†œäº§å“åˆ†çº§ã€å†·é“¾ã€åˆåŠ å·¥  
- **èåˆå‘å±•åŒº**ï¼šé‡‡æ‘˜ä½“éªŒ + ç ”å­¦ + å†œæ—…ç»“åˆ  

### ğŸ“ˆ ä¸‰ã€ç»æµæ•ˆç›Šé¢„æœŸ
- æ‘é›†ä½“å¹´å¢æ”¶ï¼š**80â€“120 ä¸‡å…ƒ**
- å†œæ°‘äººå‡å¢æ”¶ï¼š**1.5â€“2 ä¸‡å…ƒ**
- å¸¦åŠ¨å°±ä¸šå²—ä½ï¼š**50+**
        """)

        df_plan = pd.DataFrame({
            "äº§ä¸šæ–¹å‘": ["è®¾æ–½å†œä¸š", "å†œäº§å“åŠ å·¥", "å†œæ—…èåˆ"],
            "æŠ•èµ„è§„æ¨¡(ä¸‡å…ƒ)": [300, 200, 150],
            "é¢„æœŸæ”¶ç›Š(ä¸‡å…ƒ/å¹´)": [180, 120, 100]
        })

        st.subheader("äº§ä¸šæŠ•èµ„ä¸æ”¶ç›Šæµ‹ç®—")
        st.dataframe(df_plan, use_container_width=True)

        fig = px.bar(
            df_plan,
            x="äº§ä¸šæ–¹å‘",
            y="é¢„æœŸæ”¶ç›Š(ä¸‡å…ƒ/å¹´)",
            title="ç‰¹è‰²äº§ä¸šé¢„æœŸæ”¶ç›Šå¯¹æ¯”"
        )
        st.plotly_chart(fig, use_container_width=True)

# =====================================================
st.divider()
st.caption("Â© 2025 ä¹¡æ‘èµ„æºç»¼åˆåˆ†æç³»ç»Ÿ | ç»ˆæå±•ç¤ºä¸æäº¤ç‰ˆæœ¬")